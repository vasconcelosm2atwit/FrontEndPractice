import _slicedToArray from "@babel/runtime/helpers/esm/slicedToArray";
import React, { memo, useRef, useState, useEffect } from 'react';
import PropTypes from 'prop-types';
import { Textarea } from '../../textarea';
var EditableCellField = memo(function EditableCellField(props) {
  var getTargetRef = props.getTargetRef;

  var getTableBodyRef = function getTableBodyRef() {
    var ref = getTargetRef();
    if (!ref) return;

    while (ref) {
      var isTableBody = ref.hasAttribute('data-evergreen-table-body');

      if (isTableBody) {
        return ref;
      }

      if (ref.parentElement) {
        ref = ref.parentElement;
      } else {
        return null;
      }
    }

    return ref;
  };

  var latestAnimationFrame = useRef();
  var textareaRef = useRef();
  var tableBodyRef = useRef();

  var _useState = useState({
    top: 0,
    left: 0,
    height: 0,
    width: 0
  }),
      _useState2 = _slicedToArray(_useState, 2),
      _useState2$ = _useState2[0],
      height = _useState2$.height,
      width = _useState2$.width,
      top = _useState2$.top,
      left = _useState2$.left,
      setDimensions = _useState2[1]; // Mirrors functionality of componentDidMount and componentWillUnmount.
  // Focus on mount


  useEffect(function () {
    update();
    var requestId = requestAnimationFrame(function () {
      if (textareaRef.current) {
        textareaRef.current.focus();
      }
    });
    return function () {
      cancelAnimationFrame(requestId);

      if (latestAnimationFrame.current) {
        cancelAnimationFrame(latestAnimationFrame.current);
      }

      props.onCancel();
    };
  }, []);

  var update = function update() {
    var getTargetRef = props.getTargetRef;
    var targetRef = getTargetRef();
    if (!targetRef) return;
    tableBodyRef.current = getTableBodyRef();

    var _targetRef$getBoundin = targetRef.getBoundingClientRect(),
        targetLeft = _targetRef$getBoundin.left,
        targetTop = _targetRef$getBoundin.top,
        targetHeight = _targetRef$getBoundin.height,
        targetWidth = _targetRef$getBoundin.width;

    var calculatedTop;

    if (tableBodyRef.current) {
      var bounds = tableBodyRef.current.getBoundingClientRect();
      calculatedTop = Math.min(Math.max(targetTop, bounds.top), bounds.bottom - targetHeight);
    } else {
      calculatedTop = targetTop;
    }

    setDimensions({
      top: calculatedTop,
      left: targetLeft,
      height: targetHeight,
      width: targetWidth
    });
    latestAnimationFrame.current = requestAnimationFrame(function () {
      return update();
    });
  };

  var handleFocus = function handleFocus(e) {
    e.target.selectionStart = e.target.value.length;
  };

  var handleBlur = function handleBlur() {
    if (textareaRef.current) props.onChangeComplete(textareaRef.current.value);
  };

  var handleKeyDown = function handleKeyDown(e) {
    switch (e.key) {
      case 'Escape':
        props.onCancel();
        if (textareaRef.current) textareaRef.current.blur();
        break;

      case 'Enter':
        if (textareaRef.current) textareaRef.current.blur();
        e.preventDefault();
        break;

      case 'Tab':
        if (textareaRef.current) textareaRef.current.blur();
        break;

      default:
        break;
    }
  };

  var size = props.size,
      value = props.value,
      _props$minWidth = props.minWidth,
      minWidth = _props$minWidth === void 0 ? 80 : _props$minWidth,
      _props$minHeight = props.minHeight,
      minHeight = _props$minHeight === void 0 ? 40 : _props$minHeight,
      zIndex = props.zIndex;
  return React.createElement(Textarea, {
    ref: textareaRef,
    onKeyDown: handleKeyDown,
    onBlur: handleBlur,
    onFocus: handleFocus,
    appearance: "editable-cell",
    size: size,
    style: {
      left: left,
      top: top,
      height: height,
      minHeight: Math.max(height, minHeight),
      width: width,
      minWidth: Math.max(width, minWidth),
      zIndex: zIndex
    },
    height: null,
    width: null,
    minHeight: null,
    position: "fixed",
    defaultValue: value
  });
});
EditableCellField.propTypes = {
  /**
   * Used as the defaultValue of the textarea.
   */
  value: PropTypes.string.isRequired,

  /**
   * The z-index placed on the element.
   */
  zIndex: PropTypes.number.isRequired,

  /**
   * Function to get the target ref of the parent.
   * Used to mirror the position.
   */
  getTargetRef: PropTypes.func.isRequired,

  /**
   * Min width of the textarea.
   * The textarea can never be smaller than the cell.
   */
  minWidth: PropTypes.number,

  /**
   * Min height of the textarea.
   * The textarea can never be smaller than the cell.
   */
  minHeight: PropTypes.number,

  /**
   * Called when the textarea is blurred, pass the value back to the cell.
   */
  onChangeComplete: PropTypes.func.isRequired,

  /**
   * Called when Escape is hit or componentWillUnmount.
   */
  onCancel: PropTypes.func.isRequired,

  /**
   * Text size of the textarea.
   */
  size: PropTypes.number
};
export default EditableCellField;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWJsZS9zcmMvRWRpdGFibGVDZWxsRmllbGQuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJtZW1vIiwidXNlUmVmIiwidXNlU3RhdGUiLCJ1c2VFZmZlY3QiLCJQcm9wVHlwZXMiLCJUZXh0YXJlYSIsIkVkaXRhYmxlQ2VsbEZpZWxkIiwicHJvcHMiLCJnZXRUYXJnZXRSZWYiLCJnZXRUYWJsZUJvZHlSZWYiLCJyZWYiLCJpc1RhYmxlQm9keSIsImhhc0F0dHJpYnV0ZSIsInBhcmVudEVsZW1lbnQiLCJsYXRlc3RBbmltYXRpb25GcmFtZSIsInRleHRhcmVhUmVmIiwidGFibGVCb2R5UmVmIiwidG9wIiwibGVmdCIsImhlaWdodCIsIndpZHRoIiwic2V0RGltZW5zaW9ucyIsInVwZGF0ZSIsInJlcXVlc3RJZCIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImN1cnJlbnQiLCJmb2N1cyIsImNhbmNlbEFuaW1hdGlvbkZyYW1lIiwib25DYW5jZWwiLCJ0YXJnZXRSZWYiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJ0YXJnZXRMZWZ0IiwidGFyZ2V0VG9wIiwidGFyZ2V0SGVpZ2h0IiwidGFyZ2V0V2lkdGgiLCJjYWxjdWxhdGVkVG9wIiwiYm91bmRzIiwiTWF0aCIsIm1pbiIsIm1heCIsImJvdHRvbSIsImhhbmRsZUZvY3VzIiwiZSIsInRhcmdldCIsInNlbGVjdGlvblN0YXJ0IiwidmFsdWUiLCJsZW5ndGgiLCJoYW5kbGVCbHVyIiwib25DaGFuZ2VDb21wbGV0ZSIsImhhbmRsZUtleURvd24iLCJrZXkiLCJibHVyIiwicHJldmVudERlZmF1bHQiLCJzaXplIiwibWluV2lkdGgiLCJtaW5IZWlnaHQiLCJ6SW5kZXgiLCJwcm9wVHlwZXMiLCJzdHJpbmciLCJpc1JlcXVpcmVkIiwibnVtYmVyIiwiZnVuYyJdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU9BLEtBQVAsSUFBZ0JDLElBQWhCLEVBQXNCQyxNQUF0QixFQUE4QkMsUUFBOUIsRUFB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cG9ydCBSZWFjdCwgeyBtZW1vLCB1c2VSZWYsIHVzZVN0YXRlLCB1c2VFZmZlY3QgfSBmcm9tICdyZWFjdCdcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCB7IFRleHRhcmVhIH0gZnJvbSAnLi4vLi4vdGV4dGFyZWEnXG5cbmNvbnN0IEVkaXRhYmxlQ2VsbEZpZWxkID0gbWVtbyhmdW5jdGlvbiBFZGl0YWJsZUNlbGxGaWVsZChwcm9wcykge1xuICBjb25zdCB7IGdldFRhcmdldFJlZiB9ID0gcHJvcHNcblxuICBjb25zdCBnZXRUYWJsZUJvZHlSZWYgPSAoKSA9PiB7XG4gICAgbGV0IHJlZiA9IGdldFRhcmdldFJlZigpXG5cbiAgICBpZiAoIXJlZikgcmV0dXJuXG5cbiAgICB3aGlsZSAocmVmKSB7XG4gICAgICBjb25zdCBpc1RhYmxlQm9keSA9IHJlZi5oYXNBdHRyaWJ1dGUoJ2RhdGEtZXZlcmdyZWVuLXRhYmxlLWJvZHknKVxuICAgICAgaWYgKGlzVGFibGVCb2R5KSB7XG4gICAgICAgIHJldHVybiByZWZcbiAgICAgIH1cblxuICAgICAgaWYgKHJlZi5wYXJlbnRFbGVtZW50KSB7XG4gICAgICAgIHJlZiA9IHJlZi5wYXJlbnRFbGVtZW50XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZWZcbiAgfVxuXG4gIGNvbnN0IGxhdGVzdEFuaW1hdGlvbkZyYW1lID0gdXNlUmVmKClcbiAgY29uc3QgdGV4dGFyZWFSZWYgPSB1c2VSZWYoKVxuICBjb25zdCB0YWJsZUJvZHlSZWYgPSB1c2VSZWYoKVxuICBjb25zdCBbeyBoZWlnaHQsIHdpZHRoLCB0b3AsIGxlZnQgfSwgc2V0RGltZW5zaW9uc10gPSB1c2VTdGF0ZSh7XG4gICAgdG9wOiAwLFxuICAgIGxlZnQ6IDAsXG4gICAgaGVpZ2h0OiAwLFxuICAgIHdpZHRoOiAwXG4gIH0pXG5cbiAgLy8gTWlycm9ycyBmdW5jdGlvbmFsaXR5IG9mIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnRXaWxsVW5tb3VudC5cbiAgLy8gRm9jdXMgb24gbW91bnRcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICB1cGRhdGUoKVxuXG4gICAgY29uc3QgcmVxdWVzdElkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIGlmICh0ZXh0YXJlYVJlZi5jdXJyZW50KSB7XG4gICAgICAgIHRleHRhcmVhUmVmLmN1cnJlbnQuZm9jdXMoKVxuICAgICAgfVxuICAgIH0pXG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmVxdWVzdElkKVxuXG4gICAgICBpZiAobGF0ZXN0QW5pbWF0aW9uRnJhbWUuY3VycmVudCkge1xuICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShsYXRlc3RBbmltYXRpb25GcmFtZS5jdXJyZW50KVxuICAgICAgfVxuXG4gICAgICBwcm9wcy5vbkNhbmNlbCgpXG4gICAgfVxuICB9LCBbXSlcblxuICBjb25zdCB1cGRhdGUgPSAoKSA9PiB7XG4gICAgY29uc3QgeyBnZXRUYXJnZXRSZWYgfSA9IHByb3BzXG4gICAgY29uc3QgdGFyZ2V0UmVmID0gZ2V0VGFyZ2V0UmVmKClcbiAgICBpZiAoIXRhcmdldFJlZikgcmV0dXJuXG4gICAgdGFibGVCb2R5UmVmLmN1cnJlbnQgPSBnZXRUYWJsZUJvZHlSZWYoKVxuXG4gICAgY29uc3Qge1xuICAgICAgbGVmdDogdGFyZ2V0TGVmdCxcbiAgICAgIHRvcDogdGFyZ2V0VG9wLFxuICAgICAgaGVpZ2h0OiB0YXJnZXRIZWlnaHQsXG4gICAgICB3aWR0aDogdGFyZ2V0V2lkdGhcbiAgICB9ID0gdGFyZ2V0UmVmLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG5cbiAgICBsZXQgY2FsY3VsYXRlZFRvcFxuICAgIGlmICh0YWJsZUJvZHlSZWYuY3VycmVudCkge1xuICAgICAgY29uc3QgYm91bmRzID0gdGFibGVCb2R5UmVmLmN1cnJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICAgIGNhbGN1bGF0ZWRUb3AgPSBNYXRoLm1pbihcbiAgICAgICAgTWF0aC5tYXgodGFyZ2V0VG9wLCBib3VuZHMudG9wKSxcbiAgICAgICAgYm91bmRzLmJvdHRvbSAtIHRhcmdldEhlaWdodFxuICAgICAgKVxuICAgIH0gZWxzZSB7XG4gICAgICBjYWxjdWxhdGVkVG9wID0gdGFyZ2V0VG9wXG4gICAgfVxuXG4gICAgc2V0RGltZW5zaW9ucyh7XG4gICAgICB0b3A6IGNhbGN1bGF0ZWRUb3AsXG4gICAgICBsZWZ0OiB0YXJnZXRMZWZ0LFxuICAgICAgaGVpZ2h0OiB0YXJnZXRIZWlnaHQsXG4gICAgICB3aWR0aDogdGFyZ2V0V2lkdGhcbiAgICB9KVxuICAgIGxhdGVzdEFuaW1hdGlvbkZyYW1lLmN1cnJlbnQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdXBkYXRlKCkpXG4gIH1cblxuICBjb25zdCBoYW5kbGVGb2N1cyA9IGUgPT4ge1xuICAgIGUudGFyZ2V0LnNlbGVjdGlvblN0YXJ0ID0gZS50YXJnZXQudmFsdWUubGVuZ3RoXG4gIH1cblxuICBjb25zdCBoYW5kbGVCbHVyID0gKCkgPT4ge1xuICAgIGlmICh0ZXh0YXJlYVJlZi5jdXJyZW50KSBwcm9wcy5vbkNoYW5nZUNvbXBsZXRlKHRleHRhcmVhUmVmLmN1cnJlbnQudmFsdWUpXG4gIH1cblxuICBjb25zdCBoYW5kbGVLZXlEb3duID0gZSA9PiB7XG4gICAgc3dpdGNoIChlLmtleSkge1xuICAgICAgY2FzZSAnRXNjYXBlJzpcbiAgICAgICAgcHJvcHMub25DYW5jZWwoKVxuICAgICAgICBpZiAodGV4dGFyZWFSZWYuY3VycmVudCkgdGV4dGFyZWFSZWYuY3VycmVudC5ibHVyKClcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ0VudGVyJzpcbiAgICAgICAgaWYgKHRleHRhcmVhUmVmLmN1cnJlbnQpIHRleHRhcmVhUmVmLmN1cnJlbnQuYmx1cigpXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnVGFiJzpcbiAgICAgICAgaWYgKHRleHRhcmVhUmVmLmN1cnJlbnQpIHRleHRhcmVhUmVmLmN1cnJlbnQuYmx1cigpXG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVha1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHsgc2l6ZSwgdmFsdWUsIG1pbldpZHRoID0gODAsIG1pbkhlaWdodCA9IDQwLCB6SW5kZXggfSA9IHByb3BzXG5cbiAgcmV0dXJuIChcbiAgICA8VGV4dGFyZWFcbiAgICAgIHJlZj17dGV4dGFyZWFSZWZ9XG4gICAgICBvbktleURvd249e2hhbmRsZUtleURvd259XG4gICAgICBvbkJsdXI9e2hhbmRsZUJsdXJ9XG4gICAgICBvbkZvY3VzPXtoYW5kbGVGb2N1c31cbiAgICAgIGFwcGVhcmFuY2U9XCJlZGl0YWJsZS1jZWxsXCJcbiAgICAgIHNpemU9e3NpemV9XG4gICAgICBzdHlsZT17e1xuICAgICAgICBsZWZ0LFxuICAgICAgICB0b3AsXG4gICAgICAgIGhlaWdodCxcbiAgICAgICAgbWluSGVpZ2h0OiBNYXRoLm1heChoZWlnaHQsIG1pbkhlaWdodCksXG4gICAgICAgIHdpZHRoLFxuICAgICAgICBtaW5XaWR0aDogTWF0aC5tYXgod2lkdGgsIG1pbldpZHRoKSxcbiAgICAgICAgekluZGV4XG4gICAgICB9fVxuICAgICAgaGVpZ2h0PXtudWxsfVxuICAgICAgd2lkdGg9e251bGx9XG4gICAgICBtaW5IZWlnaHQ9e251bGx9XG4gICAgICBwb3NpdGlvbj1cImZpeGVkXCJcbiAgICAgIGRlZmF1bHRWYWx1ZT17dmFsdWV9XG4gICAgLz5cbiAgKVxufSlcblxuRWRpdGFibGVDZWxsRmllbGQucHJvcFR5cGVzID0ge1xuICAvKipcbiAgICogVXNlZCBhcyB0aGUgZGVmYXVsdFZhbHVlIG9mIHRoZSB0ZXh0YXJlYS5cbiAgICovXG4gIHZhbHVlOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG5cbiAgLyoqXG4gICAqIFRoZSB6LWluZGV4IHBsYWNlZCBvbiB0aGUgZWxlbWVudC5cbiAgICovXG4gIHpJbmRleDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiB0byBnZXQgdGhlIHRhcmdldCByZWYgb2YgdGhlIHBhcmVudC5cbiAgICogVXNlZCB0byBtaXJyb3IgdGhlIHBvc2l0aW9uLlxuICAgKi9cbiAgZ2V0VGFyZ2V0UmVmOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBNaW4gd2lkdGggb2YgdGhlIHRleHRhcmVhLlxuICAgKiBUaGUgdGV4dGFyZWEgY2FuIG5ldmVyIGJlIHNtYWxsZXIgdGhhbiB0aGUgY2VsbC5cbiAgICovXG4gIG1pbldpZHRoOiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gIC8qKlxuICAgKiBNaW4gaGVpZ2h0IG9mIHRoZSB0ZXh0YXJlYS5cbiAgICogVGhlIHRleHRhcmVhIGNhbiBuZXZlciBiZSBzbWFsbGVyIHRoYW4gdGhlIGNlbGwuXG4gICAqL1xuICBtaW5IZWlnaHQ6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgLyoqXG4gICAqIENhbGxlZCB3aGVuIHRoZSB0ZXh0YXJlYSBpcyBibHVycmVkLCBwYXNzIHRoZSB2YWx1ZSBiYWNrIHRvIHRoZSBjZWxsLlxuICAgKi9cbiAgb25DaGFuZ2VDb21wbGV0ZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAvKipcbiAgICogQ2FsbGVkIHdoZW4gRXNjYXBlIGlzIGhpdCBvciBjb21wb25lbnRXaWxsVW5tb3VudC5cbiAgICovXG4gIG9uQ2FuY2VsOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBUZXh0IHNpemUgb2YgdGhlIHRleHRhcmVhLlxuICAgKi9cbiAgc2l6ZTogUHJvcFR5cGVzLm51bWJlclxufVxuXG5leHBvcnQgZGVmYXVsdCBFZGl0YWJsZUNlbGxGaWVsZFxuIl19